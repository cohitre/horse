#!/usr/bin/env ruby

module Horse
  HORSES = YAML.load(File.read('horses.yml'))
  COLORS = { :default => "[39m",
             :red     => "[31m",
             :green   => "[32m",
             :yellow  => "[33m",
             :magenta => "[35m",
             :cyan    => "[36m"
           }
  COLOR_ARRAY = COLORS.values - [COLORS[:default]]

  class << self
    def play
      horse = nil
      while horse.nil?
        puts "Which horse would you like to bet on?"
        HORSES.each_with_index do |name, index|
          puts "#{index + 1}. #{name}"
        end
        print "[1-#{HORSES.size}] "
        number = gets
        begin
          number = Integer(number)
        rescue Exception
          puts "Please enter a number."
          puts
          redo
        end
        horse = HORSES[number]
      end
      puts

      winner = nil
      while winner.nil?
        puts "How much do you want to bet?"
        print "$"
        amount = gets
        begin
          amount = Float(amount)
        rescue Exception
          puts "Please enter a number."
          puts
          redo
        end
        winner = HORSES[rand(HORSES.size)]
      end
      puts

      spin

      if winner == horse
        puts "YOU WON #{amount}!!!!!!!!"
      else
        puts "BITCH YOU LOSTTTTTTTTTTT! THE WINNER WAS #{winner}"
      end
    end

    private
    def spin
      hide_cursor
      10.times do
        n = rand(11) + 10
        loop_print_flush_sleep(n, '.')
        loop_print_flush_sleep(n, "\b \b")
      end
      show_cursor
      print "\e#{COLORS[:default]}"
    end

    def loop_print_flush_sleep(n, str)
      n.times do
        print "\e#{COLOR_ARRAY[rand(COLOR_ARRAY.size)]}"
        print str
        STDOUT.flush
        sleep rand / 100 * 3
      end
    end

    def hide_cursor
      print "\e[?25l"
    end

    def show_cursor
      print "\e[?25h"
    end
  end
end

if __FILE__ == $0
  Horse.play
end
